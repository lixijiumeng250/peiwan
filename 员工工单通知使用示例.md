# 员工工单通知使用示例

## 概述

本文档展示如何在员工页面中使用工单通知功能，包括获取工单通知、显示弹窗、确认已读等操作。

## 1. 基本使用方法

### 在员工页面中使用组合式函数

```vue
<template>
  <div class="employee-page">
    <!-- 通知弹窗组件（已集成） -->
    <NotificationPopup />
    
    <!-- 工单通知列表 -->
    <div class="order-notifications" v-if="unreadOrderCount > 0">
      <h3>未读工单通知 ({{ unreadOrderCount }})</h3>
      
      <div class="notification-actions">
        <el-button @click="refreshOrderNotifications" :loading="isLoading">
          刷新通知
        </el-button>
        <el-button @click="markAllOrderNotificationsAsRead" type="primary">
          全部已读
        </el-button>
      </div>
      
      <div class="notification-list">
        <div 
          v-for="notification in orderNotifications" 
          :key="notification.id"
          class="notification-item"
          :class="{ 'unread': !notification.isRead }"
        >
          <div class="notification-content">
            <h4>{{ notification.title }}</h4>
            <p>{{ notification.content }}</p>
            <div class="order-info" v-if="getOrderData(notification)">
              <span>工单号: {{ getOrderData(notification).orderNumber }}</span>
              <span>派单客服: {{ getOrderData(notification).csUserName }}</span>
            </div>
            <span class="time">{{ formatTime(notification.createTime) }}</span>
          </div>
          
          <div class="notification-actions" v-if="!notification.isRead">
            <el-button 
              size="small" 
              @click="markOrderNotificationAsRead(notification.id)"
            >
              标为已读
            </el-button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 其他员工页面内容 -->
    <div class="main-content">
      <!-- ... -->
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useOrderNotifications } from '@/composables/useOrderNotifications'
import NotificationPopup from '@/components/NotificationPopup.vue'

// 使用工单通知组合式函数
const {
  orderNotifications,
  unreadOrderCount,
  isLoading,
  fetchOrderNotifications,
  markOrderNotificationAsRead,
  markAllOrderNotificationsAsRead,
  getOrderNotificationData
} = useOrderNotifications()

// 刷新工单通知
const refreshOrderNotifications = fetchOrderNotifications

// 获取工单数据
function getOrderData(notification) {
  return getOrderNotificationData(notification)
}

// 格式化时间
function formatTime(timeString) {
  return new Date(timeString).toLocaleString('zh-CN')
}
</script>
```

## 2. API接口使用

### 直接调用API获取工单通知

```javascript
import notificationsAPI from '@/api/notifications'

// 获取所有工单派发通知（不限制数量）
async function getOrderNotifications() {
  try {
    const response = await notificationsAPI.getOrderAssignmentNotifications()
    console.log('工单通知:', response.data)
    return response.data
  } catch (error) {
    console.error('获取工单通知失败:', error)
    return []
  }
}

// 获取指定数量的工单通知
async function getLimitedOrderNotifications(limit = 10) {
  try {
    const response = await notificationsAPI.getUnreadNotificationsByType('ORDER_ASSIGNMENT', limit)
    console.log('工单通知:', response.data)
    return response.data
  } catch (error) {
    console.error('获取工单通知失败:', error)
    return []
  }
}
```

### 使用通知管理器

```javascript
import notificationManager from '@/utils/notificationManager'

// 获取工单通知
async function getOrderNotifications() {
  const notifications = await notificationManager.getOrderAssignmentNotifications()
  console.log('工单通知:', notifications)
  return notifications
}

// 标记通知为已读
async function markAsRead(notificationId) {
  await notificationManager.markAsRead(notificationId)
}
```

## 3. 弹窗功能

### 工单派发弹窗特性

当收到新的工单派发通知时，系统会自动显示弹窗，包含以下信息：

- **工单基本信息**：工单号、委托人信息
- **派单信息**：派单客服、派单时间
- **工单截图**：如果有的话，会显示派单信息截图
- **操作按钮**：
  - 稍后处理：关闭弹窗但不标记已读
  - **确认已读**：标记消息为已读并关闭弹窗
  - 查看工单详情：跳转到工单详情页面

### 弹窗数据结构

```javascript
// 工单通知数据结构
const orderNotificationData = {
  "orderId": 10,
  "orderNumber": "ORD20240101001",
  "clientInfo": "用户ABC",
  "orderInfoScreenshotUrl": "https://example.com/screenshot.jpg",
  "assignedEmployeeId": 5,
  "assignedEmployeeName": "张三",
  "csUserId": 2,
  "csUserName": "李四",
  "assignedTime": "2024-01-01 10:30:00",
  "notificationType": "ORDER_ASSIGNED",
  "message": "客服 李四 为您派发了新工单：ORD20240101001"
}
```

## 4. 实际应用场景

### 场景1：员工登录后查看所有未读工单通知

```javascript
// 在员工页面的 onMounted 钩子中
onMounted(async () => {
  // 获取所有工单通知
  const notifications = await notificationManager.getOrderAssignmentNotifications()
  
  // 过滤未读通知
  const unreadNotifications = notifications.filter(n => !n.isRead)
  
  if (unreadNotifications.length > 0) {
    console.log(`您有 ${unreadNotifications.length} 条未读工单通知`)
    
    // 可以显示提醒或者自动显示通知列表
    showNotificationReminder(unreadNotifications.length)
  }
})
```

### 场景2：实时接收新工单通知

```javascript
// 监听新工单通知
notificationManager.on('orderAssignment', (payload) => {
  const { notification, data } = payload
  
  console.log('收到新工单:', data.orderNumber)
  
  // 可以播放提示音
  playNotificationSound()
  
  // 或者显示桌面通知
  if (Notification.permission === 'granted') {
    new Notification('新工单派发', {
      body: `客服 ${data.csUserName} 为您派发了工单：${data.orderNumber}`,
      icon: '/favicon.ico'
    })
  }
})
```

### 场景3：批量处理工单通知

```javascript
// 批量确认所有工单通知
async function confirmAllOrderNotifications() {
  try {
    // 获取所有未读工单通知
    const notifications = await notificationManager.getOrderAssignmentNotifications()
    const unreadIds = notifications.filter(n => !n.isRead).map(n => n.id)
    
    if (unreadIds.length > 0) {
      // 批量标记为已读
      await notificationManager.markBatchAsRead(unreadIds)
      ElMessage.success(`已确认 ${unreadIds.length} 条工单通知`)
    } else {
      ElMessage.info('没有未读的工单通知')
    }
  } catch (error) {
    ElMessage.error('批量确认失败')
  }
}
```

## 5. 注意事项

1. **权限验证**：确保只有员工角色才能接收工单派发通知
2. **数据解析**：通知的详细数据存储在 `data` 字段中，需要 JSON 解析
3. **错误处理**：网络请求失败时要有适当的错误提示
4. **性能优化**：避免频繁请求，利用轮询机制和缓存
5. **用户体验**：提供清晰的视觉反馈和操作按钮

## 6. 完整的接口列表

### 获取通知
- `GET /api/notifications/type/ORDER_ASSIGNMENT` - 获取所有工单派发通知
- `GET /api/notifications/unread/count` - 获取未读通知数量
- `GET /api/notifications/unread` - 获取未读通知列表

### 标记已读
- `POST /api/notifications/{id}/read` - 标记单个通知为已读
- `POST /api/notifications/batch-read` - 批量标记通知为已读
- `POST /api/notifications/read-all` - 标记所有通知为已读

这样，员工就可以通过这些接口和组件来接收、查看和处理工单派发通知了。
